<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Manage WAF Rules</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 1400px; margin: 2em auto; padding: 2em; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        h1, h2 { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5em; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { padding: 0.75em; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 14px; }
        thead { background-color: #e9ecef; }
        form { margin-top: 2em; padding: 1.5em; border: 1px solid #dee2e6; border-radius: 8px; }
        form input[type="text"], form input[type="number"], form select { width: 100%; padding: 0.5em; margin-bottom: 1em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        form button { padding: 0.7em 1.5em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* Nút Delete đẹp */
        .btn-delete {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            padding: 0.6em 1.2em;
            background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.25), 0 2px 4px rgba(255, 71, 87, 0.15);
            position: relative;
            overflow: hidden;
        }

        .btn-delete::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-delete:hover::before {
            left: 100%;
        }

        .btn-delete:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 71, 87, 0.4), 0 4px 8px rgba(255, 71, 87, 0.25);
            background: linear-gradient(135deg, #ff5e6c 0%, #ee5a6f 100%);
        }

        .btn-delete:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 3px 10px rgba(255, 71, 87, 0.3);
        }

        .btn-delete svg {
            width: 15px;
            height: 15px;
            fill: currentColor;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        .category-sql-injection { background-color: #dc3545; }
        .category-xss { background-color: #fd7e14; }
        .category-bot-protection { background-color: #20c997; }
        .category-path-traversal { background-color: #6f42c1; }
        .category-command-injection { background-color: #e83e8c; }
        .category-file-upload { background-color: #17a2b8; }
        .category-rate-limiting { background-color: #28a745; }
        .category-custom { background-color: #6c757d; }
        .category-nosql-injection { background-color: #ff6b35; }
        .category-injection { background-color: #e83e8c; }
        /* New categories */
        .category-scanner-bot { background-color: #20c997; }              /* tương tự Bot Protection */
        .category-protocol-manipulation { background-color: #007bff; }    /* xanh dương */
        .category-ssti { background-color: #6f42c1; }                     /* tím */
        .category-lfi-rce { background-color: #343a40; }                  /* xám đậm */
        .flashes { list-style-type: none; padding: 0; margin-top: 1em; }
        .flashes li { padding: 0.75em; border-radius: 4px; margin-bottom: 0.5em; }
        .flashes .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flashes .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <p><a href="/">&larr; Back to Dashboard</a></p>
        <h1>Manage Security Rules</h1>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Enabled</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Target</th>
                    <th>Operator</th>
                    <th style="width: 25%;">Value</th>
                    <th>Rule Action</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in rules %}
                <tr>
                    <td>{{ rule.id }}</td>
                    <td>{{ 'Yes' if rule.enabled else 'No' }}</td>
                    <td>{{ rule.description }}</td>
                    <td><span class="category-badge category-{{ rule.category.lower().replace(' ', '-').replace('/', '-') }}">{{ rule.category }}</span></td>
                    <td>{{ rule.target }}</td>
                    <td>{{ rule.operator }}</td>
                    <td style="word-break: break-all;">{{ rule.value }}</td>
                    <td>{{ rule.action }}</td>
                    <td>
                        <form action="{{ url_for('delete_rule', rule_id=rule.id) }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn xóa rule {{ rule.id }}?');" style="display: inline; margin: 0; padding: 0; border: none;">
                            <button type="submit" class="btn-delete" title="Xóa rule này">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <form action="{{ url_for('add_rule') }}" method="post">
            <h2>Add New Rule</h2>
            <input type="number" name="id" placeholder="Rule ID (e.g., 102)" required>
            <input type="text" name="description" placeholder="Description (e.g., Block specific user agent)" required>
            <select name="category" required>
                <option value="" disabled selected>Select Category</option>
                <option value="SQL Injection">SQL Injection</option>
                <option value="NoSQL Injection">NoSQL Injection</option>
                <option value="XSS">Cross-Site Scripting (XSS)</option>
                <option value="Bot Protection">Bot Protection</option>
                <option value="Scanner/Bot">Scanner/Bot</option>
                <option value="Protocol Manipulation">Protocol Manipulation</option>
                <option value="SSTI">SSTI (Server-Side Template Injection)</option>
                <option value="Path Traversal">Path Traversal</option>
                <option value="LFI/RCE">LFI/RCE</option>
                <option value="Command Injection">Command Injection</option>
                <option value="File Upload">File Upload</option>
                <option value="Rate Limiting">Rate Limiting</option>
                <option value="Custom">Custom</option>
            </select>
            <select name="target" required>
                <option value="" disabled selected>Select Target</option>
                <option value="URL_PATH">URL Path</option>
                <option value="URL_QUERY">URL Query</option>
                <option value="BODY">Body</option>
                <option value="ARGS">Arguments (Parameter Values)</option>
                <option value="ARGS_NAMES">Argument Names (Parameter Names)</option>
                <option value="FILENAME">File Names (Upload)</option>
                <option value="HEADERS:User-Agent">Header: User-Agent</option>
                <option value="HEADERS:Referer">Header: Referer</option>
                <option value="HEADERS:Cookie">Header: Cookie</option>
                <option value="HEADERS:Content-Type">Header: Content-Type</option>
            </select>
            <select name="operator" required>
                <option value="" disabled selected>Select Operator</option>
                <option value="CONTAINS">CONTAINS</option>
                <option value="REGEX">REGEX</option>
            </select>
            <input type="text" name="value" placeholder="Value to match (e.g., BadBot)" required>
            <select name="rule_action" required>
                <option value="BLOCK" selected>BLOCK (block request)</option>
                <option value="LOG">LOG (only log, do not block)</option>
                <option value="ALLOW">ALLOW (explicit allow)</option>
            </select>
            <label><input type="checkbox" name="enabled" checked> Enabled</label>
            <br><br>
            <button type="submit">Add Rule</button>
        </form>

        <form action="{{ url_for('import_rules') }}" method="post" enctype="multipart/form-data">
            <h2>Import Rules from JSON</h2>
            <input type="file" name="rule_file" accept=".json" required>
            <br><br>
            <button type="submit">Import File</button>
        </form>

        <form action="{{ url_for('delete_all_rules') }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn XÓA HẾT tất cả rules hiện tại?');">
            <h2>Xóa toàn bộ rules</h2>
            <p>Nút này chỉ xóa <strong>rules</strong>, không xóa logs và blacklist IP.</p>
            <button type="submit" style="background-color:#ffc107; color:#212529;">Xóa tất cả rules</button>
        </form>

        <form action="{{ url_for('reset_all_data') }}" method="post" onsubmit="return confirm('Bạn có chắc chắn muốn XÓA TOÀN BỘ dữ liệu WAF (rules, blacklist, logs)? Hành động này không thể hoàn tác.');">
            <h2>Danger Zone</h2>
            <p><strong>Cảnh báo:</strong> Nút này sẽ xóa <strong>tất cả Rules, Blacklist IP và Logs</strong> trong database.</p>
            <button type="submit" style="background-color:#dc3545;">Reset toàn bộ database WAF</button>
        </form>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flashes">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
    </div>
</body>
</html>
